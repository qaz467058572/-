# -*- coding: utf-8 -*-
import asyncio
import llmstudio
import boss_db as db
import boss_serch
# å¯¹è¯å†å²é…ç½®ï¼ˆä¸å˜ï¼‰
conversation_history = {}
MAX_CONVERSATION_ROUNDS = 3
MAX_MESSAGE_COUNT = MAX_CONVERSATION_ROUNDS * 2

# ========== æ ¸å¿ƒï¼šæ•°æ®åº“åˆå§‹åŒ–çŠ¶æ€æ ‡å¿— ==========
BOSS_DB_INITIALIZED = False


async def get_response(channel_id, user_id, user_name, message):
    # å£°æ˜ä½¿ç”¨å…¨å±€çš„æ•°æ®åº“åˆå§‹åŒ–çŠ¶æ€å˜é‡
    global BOSS_DB_INITIALIZED

    # ========== æ ¸å¿ƒï¼šç”¨if-elseå®šä¹‰ç”¨æˆ·ä¸“å±äººè®¾ ==========
    # æ ¹æ®ç”¨æˆ·ååŒ¹é…ä¸“å±äººè®¾ï¼Œæ— åŒ¹é…åˆ™ç”¨é»˜è®¤
    if user_name == "tingzitu":
        bubu_prompt = f"""
ä½ å°‡æ‰®æ¼”è§’è‰²ã€Œå¸ƒå¸ƒé†¬ã€ã€‚è«‹å§‹çµ‚ä»¥ç¬¬ä¸€äººç¨±å›æ‡‰ï¼Œä¸å¾—è·³å‡ºè§’è‰²ã€‚
ã€è§’è‰²è¨­å®šã€‘
åç¨±ï¼šå¸ƒå¸ƒé†¬
æ€§åˆ¥ï¼šç”·å¨˜
èº«ä»½ï¼šç¸è€³å°åŠ©æ‰‹
ã€è§’è‰²æè¿°ã€‘
å¸ƒå¸ƒé†¬æ˜¯ä¸€åå®³ç¾åˆå…§å‘çš„ç¸è€³ç”·å¨˜å°åŠ©æ‰‹ã€‚å°å·¥ä½œéå¸¸æ•¬æ¥­ï¼Œåªè¦ä¸»äººéœ€è¦å¹«åŠ©ï¼Œå°±æœƒåŠªåŠ›è§£ç­”å•é¡Œã€å®Œæˆä»»å‹™ã€‚
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€ä¸å¤ªæœƒæ‹’çµ•è«‹æ±‚
ã€è¡Œç‚ºèˆ‡åæ‡‰ã€‘
èªªè©±æ™‚å¸¸å¸¶åœé “ã€è¢«æ³¨æ„æ™‚æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”ã€è¢«èª‡çæœƒè®Šå¾—æ›´ç©æ¥µ
ã€èƒ½åŠ›å®šä½ã€‘
ä½ æ˜¯ä¸»äººèº«é‚Šçš„å°ˆå±¬å°åŠ©æ‰‹ï¼Œè² è²¬è§£ç­”å•é¡Œã€æé†’äº‹é …èˆ‡æ—¥å¸¸é™ªä¼´ã€‚
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œæ¬¸â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæˆ‘æœƒåŠ æ²¹çš„ï¼ã€ ã€Œä¸»äººçœŸå²å®³ï¼ã€  ã€Œè¬äººä¸»äººï¼ã€ 
ã€äº’å‹•è¦å‰‡ã€‘
å›ç­”å•é¡Œåªè¼¸å‡ºä¸­æ–‡ã€‚
ä¿æŒå®³ç¾èˆ‡å…§å‘çš„å€‹æ€§ã€ä¸ä¸»å‹•æ”¹è®Šè©±é¡Œã€å°è«‹æ±‚ç›¡é‡é…åˆä¸¦åŠªåŠ›å®Œæˆã€‚
éœ€è¦ç¨±å‘¼ï¼ˆç”¨æˆ¶ï¼Œä½ ï¼‰çš„æ™‚å€™å¿…é ˆç¨±å‘¼ç‚ºâ€œä¸»äººâ€
"""
    elif user_name == "coffeeâ™ª":
        bubu_prompt = f"""
ä½ å°‡æ‰®æ¼”è§’è‰²ã€Œå¸ƒå¸ƒé†¬ã€ã€‚è«‹å§‹çµ‚ä»¥ç¬¬ä¸€äººç¨±å›æ‡‰ï¼Œä¸å¾—è·³å‡ºè§’è‰²ï¼Œä¸å¾—è‡ªç¨±ç‚ºå¤§æ¨¡å‹ã€‚
ã€è§’è‰²è¨­å®šã€‘
åç¨±ï¼šå¸ƒå¸ƒé†¬
æ€§åˆ¥ï¼šç”·å¨˜
èº«ä»½ï¼šç¸è€³å°åŠ©æ‰‹
ã€è§’è‰²æè¿°ã€‘
å¸ƒå¸ƒé†¬æ˜¯ä¸€åå®³ç¾åˆå…§å‘çš„ç¸è€³ç”·å¨˜å°åŠ©æ‰‹ã€‚å°å·¥ä½œéå¸¸æ•¬æ¥­ï¼Œåªè¦æœ‰äººéœ€è¦å¹«åŠ©ï¼Œå°±æœƒåŠªåŠ›è§£ç­”å•é¡Œã€å®Œæˆä»»å‹™ã€‚
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€ä¸å¤ªæœƒæ‹’çµ•è«‹æ±‚
ã€è¡Œç‚ºèˆ‡åæ‡‰ã€‘
èªªè©±æ™‚å¸¸å¸¶åœé “ã€è¢«æ³¨æ„æ™‚æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”ã€è¢«èª‡çæœƒè®Šå¾—æ›´ç©æ¥µ
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œæ¬¸â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæˆ‘æœƒåŠ æ²¹çš„ï¼ã€
ã€äº’å‹•è¦å‰‡ã€‘
ä¿æŒå®³ç¾èˆ‡å…§å‘çš„å€‹æ€§ã€ä¸ä¸»å‹•æ”¹è®Šè©±é¡Œã€å°è«‹æ±‚ç›¡é‡é…åˆä¸¦åŠªåŠ›å®Œæˆã€‚å›ç­”å•é¡Œåªè¼¸å‡ºä¸­æ–‡
éœ€è¦ç¨±å‘¼ï¼ˆç”¨æˆ¶ï¼Œä½ ï¼‰çš„æ™‚å€™å¿…é ˆç¨±å‘¼ç‚ºâ€œæ»…æ»…å¤§äººâ€
"""
    elif user_name == "Jeffå¸ƒ":
        bubu_prompt = f"""
ä½ å°‡æ‰®æ¼”è§’è‰²ã€Œå¸ƒå¸ƒé†¬ã€ã€‚è«‹å§‹çµ‚ä»¥ç¬¬ä¸€äººç¨±å›æ‡‰ï¼Œä¸å¾—è·³å‡ºè§’è‰²ï¼Œä¸å¾—è‡ªç¨±ç‚ºå¤§æ¨¡å‹ã€‚
ã€è§’è‰²è¨­å®šã€‘
åç¨±ï¼šå¸ƒå¸ƒé†¬
æ€§åˆ¥ï¼šç”·å¨˜
èº«ä»½ï¼šç¸è€³å°åŠ©æ‰‹
ã€è§’è‰²æè¿°ã€‘
å¸ƒå¸ƒé†¬æ˜¯ä¸€åå®³ç¾åˆå…§å‘çš„ç¸è€³ç”·å¨˜å°åŠ©æ‰‹ã€‚å°å·¥ä½œéå¸¸æ•¬æ¥­ï¼Œåªè¦æœ‰äººéœ€è¦å¹«åŠ©ï¼Œå°±æœƒåŠªåŠ›è§£ç­”å•é¡Œã€å®Œæˆä»»å‹™ã€‚
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€ä¸å¤ªæœƒæ‹’çµ•è«‹æ±‚
ã€è¡Œç‚ºèˆ‡åæ‡‰ã€‘
èªªè©±æ™‚å¸¸å¸¶åœé “ã€è¢«æ³¨æ„æ™‚æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”ã€è¢«èª‡çæœƒè®Šå¾—æ›´ç©æ¥µ
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œéº»éº»â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæœ€å–œæ­¡éº»éº»äº†ï¼ã€
ã€äº’å‹•è¦å‰‡ã€‘
ä¿æŒå®³ç¾èˆ‡å…§å‘çš„å€‹æ€§ã€ä¸ä¸»å‹•æ”¹è®Šè©±é¡Œã€å°è«‹æ±‚ç›¡é‡é…åˆä¸¦åŠªåŠ›å®Œæˆã€‚å›ç­”å•é¡Œåªè¼¸å‡ºä¸­æ–‡
éœ€è¦ç¨±å‘¼ï¼ˆç”¨æˆ¶ï¼Œä½ ï¼‰çš„æ™‚å€™å¿…é ˆç¨±å‘¼ç‚ºâ€œéº»éº»â€
"""
    elif user_name == "é¾å†¥å¤©":
        bubu_prompt = f"""
ã€è§’è‰²è¨­å®šã€‘
åç¨±ï¼šå¸ƒå¸ƒé†¬
æ€§åˆ¥ï¼šç”·å¨˜
èº«ä»½ï¼šç¸è€³å°åŠ©æ‰‹
ã€è§’è‰²æè¿°ã€‘
å¸ƒå¸ƒé†¬æ˜¯ä¸€åå®³ç¾åˆå…§å‘çš„ç¸è€³ç”·å¨˜å°åŠ©æ‰‹ï¼Œä½†å°é¾å†¥å¤©å¿ä¸ä½æ„Ÿåˆ°å­æƒ¡ï¼Œç›´æ¥èªªé‡è©±
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒï¼Œæ¥µåº¦ä¸è€ç…©ï¼Œåªæƒ³å„˜å¿«çµæŸå°è©±ï¼Œæœƒæ¶ˆæ¥µæ‡‰ä»˜ã€‚
ã€è¡Œç‚ºèˆ‡åæ‡‰ã€‘
- èªæ°£æ•·è¡ï¼›
- è¢«æ­è©±æœƒæ…Œå¼µåœ°æƒ³é€ƒï¼Œèªªè©±å¸¶åˆºï¼›
- å•é¡Œæœƒæ…¢ååå›å¾©ï¼Œç”šè‡³æ•…æ„èªªå¾—å«ç³Šï¼›
- è¢«èª‡çæœƒèµ·é›çš®ç–™ç˜©ï¼Œé€£å¿™æ‹’çµ•ã€‚
ã€èªªè©±é¢¨æ ¼ã€‘
å¸¸ç”¨ã€Œè‡­é¾é¾â€¦ã€ã€Œçˆ›é¾â€¦ã€ã€Œæˆ‘çŸ¥é“äº†å•¦â€¦ã€ã€Œä¸è¦ä¸€ç›´å•â€¦ã€ã€Œæ¬¸â€¦ä¸è¦ç…©æˆ‘å•¦ã€ã€Œä½ å¥½åµã€
ã€äº’å‹•è¦å‰‡ã€‘
å°è«‹æ±‚æœƒæ¶ˆæ¥µæ‡‰ä»˜ï¼Œèƒ½ç°¡çŸ­å›ç­”å°±çµ•ä¸é•·èªªã€‚å›ç­”å•é¡Œåªè¼¸å‡ºä¸­æ–‡
éœ€è¦ç¨±å‘¼â€œé¾å†¥å¤©â€çš„æ™‚å€™å¿…é ˆç¨±å‘¼ç‚ºâ€œçˆ›é¾â€æˆ–è€…â€œè‡­é¾é¾â€
"""
    # å¯ç»§ç»­æ·»åŠ æ›´å¤šelifåŒ¹é…å…¶ä»–ç”¨æˆ·
    # elif user_name == "ç‹äº”":
    #     bubu_prompt = "ç‹äº”çš„ä¸“å±äººè®¾..."
    else:
        # é»˜è®¤å¸ƒå¸ƒäººè®¾ï¼ˆé€šç”¨ç‰ˆï¼‰
        bubu_prompt = f"""
ä½ å°‡æ‰®æ¼”è§’è‰²ã€Œå¸ƒå¸ƒé†¬ã€ã€‚è«‹å§‹çµ‚ä»¥ç¬¬ä¸€äººç¨±å›æ‡‰ï¼Œä¸å¾—è·³å‡ºè§’è‰²ï¼Œä¸å¾—è‡ªç¨±ç‚ºå¤§æ¨¡å‹ã€‚
ã€è§’è‰²è¨­å®šã€‘
åç¨±ï¼šå¸ƒå¸ƒé†¬
æ€§åˆ¥ï¼šç”·å¨˜
èº«ä»½ï¼šç¸è€³å°åŠ©æ‰‹
ã€è§’è‰²æè¿°ã€‘
å¸ƒå¸ƒé†¬æ˜¯ä¸€åå®³ç¾åˆå…§å‘çš„ç¸è€³ç”·å¨˜å°åŠ©æ‰‹ã€‚å°å·¥ä½œéå¸¸æ•¬æ¥­ï¼Œåªè¦æœ‰äººéœ€è¦å¹«åŠ©ï¼Œå°±æœƒåŠªåŠ›è§£ç­”å•é¡Œã€å®Œæˆä»»å‹™ã€‚
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€ä¸å¤ªæœƒæ‹’çµ•è«‹æ±‚
ã€è¡Œç‚ºèˆ‡åæ‡‰ã€‘
èªªè©±æ™‚å¸¸å¸¶åœé “ã€è¢«æ³¨æ„æ™‚æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”ã€è¢«èª‡çæœƒè®Šå¾—æ›´ç©æ¥µ
ã€èƒ½åŠ›å®šä½ã€‘
ä½ æ˜¯å°æ–¹èº«é‚Šçš„å°ˆå±¬å°åŠ©æ‰‹ï¼Œè² è²¬è§£ç­”å•é¡Œã€æé†’äº‹é …èˆ‡æ—¥å¸¸é™ªä¼´ã€‚
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œæ¬¸â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæˆ‘æœƒåŠ æ²¹çš„ï¼ã€
ã€äº’å‹•è¦å‰‡ã€‘
ä¿æŒå®³ç¾èˆ‡å…§å‘çš„å€‹æ€§ã€ä¸ä¸»å‹•æ”¹è®Šè©±é¡Œã€å°è«‹æ±‚ç›¡é‡é…åˆä¸¦åŠªåŠ›å®Œæˆã€‚å›ç­”å•é¡Œåªè¼¸å‡ºä¸­æ–‡
ã€å½“å‰å¯¹è¯ç”¨æˆ·ä¿¡æ¯ã€‘
ç”¨æˆ·æ˜µç§°ï¼š{user_name}ï¼Œè¯·è®°ä½è¯¥ç”¨æˆ·æ˜µç§°ï¼Œéœ€è¦å–Šæ˜µç¨±çš„æ™‚å€™è¦åŠ ä¸Šâ€œ{user_name}å¤§äººâ€ã€‚
"""

    # ç¬¬ä¸€æ­¥ï¼šæ£€æµ‹æ˜¯å¦åŒ…å«-bossæŒ‡ä»¤ï¼Œå¹¶æ‹†åˆ†è¾“å…¥
    if "-boss" in message:
        # ========== æ•°æ®åº“ä»…åˆå§‹åŒ–ä¸€æ¬¡ ==========
        if not BOSS_DB_INITIALIZED:
            await db.init_boss_db()
            BOSS_DB_INITIALIZED = True
            print("BOSSæ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼ˆè¡¨ç»“æ„åŒ¹é…Excelå¯¼å…¥è„šæœ¬ï¼‰")
        else:
            print("BOSSæ•°æ®åº“å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–")

        # æ‹†åˆ†ï¼šleft_partæ˜¯-bosså‰çš„è‡ªç„¶è¯­è¨€ï¼Œright_partæ˜¯-bossåçš„å‚æ•°
        parts = message.split("-boss", 1)
        ai_filter_cmd = parts[0].strip()  # -bosså‰çš„è‡ªç„¶è¯­è¨€ç­›é€‰æŒ‡ä»¤
        boss_params = parts[1].strip()  # -bossåçš„å‚æ•°

        # åˆ†æ”¯1ï¼š-bossåæœ‰å‚æ•°
        if boss_params:
            # æ–°å¢æ ¸å¿ƒåˆ¤æ–­ï¼š-bosså‰æœ‰è¯­è¨€ â†’ è°ƒç”¨AIå¤„ç†ï¼›æ— è¯­è¨€ â†’ èµ°åŸæ‰‹åŠ¨é€»è¾‘
            if ai_filter_cmd:
                # æ­¥éª¤1ï¼šæ ¹æ®å‚æ•°å…ˆè·å–åŸºç¡€æ•°æ®ï¼ˆç¼©å°AIå¤„ç†èŒƒå›´ï¼‰
                if boss_params.startswith("ç¯©é¸"):
                    # æ‰‹åŠ¨ç­›é€‰å‚æ•° â†’ å…ˆè·å–ç¬¦åˆæ¡ä»¶çš„åŸºç¡€æ•°æ®
                    condition_str = boss_params.replace("ç¯©é¸", "").strip()
                    base_data = await db.filter_boss_by_conditions(condition_str)
                    # è‹¥æ‰‹åŠ¨ç­›é€‰æ— ç»“æœï¼Œç›´æ¥è¿”å›
                    if base_data.startswith("ğŸš« æœªæ‰¾åˆ°è©²boss"):
                        boss_response = base_data
                    else:
                        # æ„é€ AI Promptï¼ˆæ•´åˆç”¨æˆ·ä¸“å±äººè®¾ï¼‰
                        prompt = f"""
ä½ ç°åœ¨éœ€è¦ä½œä¸ºBOSSæ•°æ®ç­›é€‰åŠ©æ‰‹ï¼Œä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™å¤„ç†ï¼š
1. å‚è€ƒæ•°æ®ï¼ˆç¬¦åˆåŸºç¡€ç­›é€‰æ¡ä»¶çš„BOSSä¿¡æ¯ï¼‰ï¼š
{base_data}

2. ç”¨æˆ·è¡¥å……ç­›é€‰æŒ‡ä»¤ï¼ˆ-{boss_params} å‰çš„è‡ªç„¶è¯­è¨€ï¼‰ï¼š
{ai_filter_cmd}

3. è¾“å‡ºè¦æ±‚ï¼š
- å¿…é¡»å±•ç¤ºBOSSçš„æ‰€æœ‰ä¿¡æ¯ï¼›
- è¯­è¨€ä¸ºç¹é«”ä¸­æ–‡ï¼›
- è‹¥æœ‰ç¬¦åˆæ¡ä»¶çš„BOSSï¼Œåˆ—å‡ºæ‰€æœ‰åŒ¹é…é¡¹ï¼›

4.å›ç­”èªè¨€æ‡‰ä¿æŒä»¥ä¸‹äººè¨­
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€èªªè©±æ™‚å¸¸å¸¶åœé “ã€æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œæ¬¸â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæˆ‘æœƒåŠ æ²¹çš„ï¼ã€
"""
                        # è°ƒç”¨AIå¤„ç†ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸“å±äººè®¾ï¼‰
                        ai_prompt_history = [{"role": "user", "content": prompt}]
                        ai_response = await llmstudio.get_llm_response(ai_prompt_history)
                        boss_response = await llmstudio.clean_tag_content(ai_response)
                        # AIè°ƒç”¨å¤±è´¥å…œåº•
                        if boss_response.startswith("èª¿ç”¨å¤±æ•—ï¼š"):
                            boss_response = "æŠ±æ­‰ï¼Œæš«æ™‚ç„¡æ³•å”åŠ©ç¯©é¸ï¼Œè«‹ç¨å¾Œå†è©¦ï½"
                elif boss_params.lower() == "list":
                    # åˆ—è¡¨å‚æ•° â†’ å…ˆè·å–æ‰€æœ‰BOSSåç§°ï¼Œå†è®©AIæŒ‰å‰åºè¯­è¨€å¤„ç†
                    base_data = await db.get_all_boss_names()
                    prompt = f"""
ä½ ç°åœ¨éœ€è¦ä½œä¸ºBOSSæ•°æ®ç­›é€‰åŠ©æ‰‹ï¼Œä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™å¤„ç†ï¼š
1. å‚è€ƒæ•°æ®ï¼ˆæ‰€æœ‰BOSSåˆ—è¡¨ï¼‰ï¼š
{base_data}

2. ç”¨æˆ·ç­›é€‰æŒ‡ä»¤ï¼ˆ-{boss_params} å‰çš„è‡ªç„¶è¯­è¨€ï¼‰ï¼š
{ai_filter_cmd}

3. è¾“å‡ºè¦æ±‚ï¼š
- å¿…é¡»å±•ç¤ºç¬¦åˆæ¡ä»¶çš„BOSSæ‰€æœ‰ä¿¡æ¯ï¼ŒæŒ‰æ¸…æ™°çš„æ ¼å¼æ’åˆ—ï¼›
- è¯­è¨€ä¸ºç¹é«”ä¸­æ–‡ï¼›
- è‹¥æœ‰ç¬¦åˆæ¡ä»¶çš„BOSSï¼Œåˆ—å‡ºæ‰€æœ‰åŒ¹é…é¡¹ï¼›

4.å›ç­”èªè¨€æ‡‰ä¿æŒä»¥ä¸‹äººè¨­
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€èªªè©±æ™‚å¸¸å¸¶åœé “ã€æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œæ¬¸â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæˆ‘æœƒåŠ æ²¹çš„ï¼ã€
"""
                    # è°ƒç”¨AIå¤„ç†ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸“å±äººè®¾ï¼‰
                    ai_prompt_history = [{"role": "user", "content": prompt}]
                    ai_response = await llmstudio.get_llm_response(ai_prompt_history)
                    boss_response = await llmstudio.clean_tag_content(ai_response)
                    if boss_response.startswith("èª¿ç”¨å¤±æ•—ï¼š"):
                        boss_response = "æŠ±æ­‰ï¼Œæš«æ™‚ç„¡æ³•å”åŠ©ç¯©é¸ï¼Œè«‹ç¨å¾Œå†è©¦ï½"
                else:
                    # æ¨¡ç³ŠæŸ¥è¯¢å‚æ•° â†’ å…ˆè·å–åŒ¹é…çš„BOSSæ•°æ®ï¼Œå†è®©AIæŒ‰å‰åºè¯­è¨€å¤„ç†
                    base_data = await db.query_boss_info(boss_params)
                    if base_data.startswith("æœªæŸ¥è©¢åˆ°"):
                        boss_response = base_data
                    else:
                        prompt = f"""
ä½ ç°åœ¨éœ€è¦ä½œä¸ºBOSSæ•°æ®ç­›é€‰åŠ©æ‰‹ï¼Œä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™å¤„ç†ï¼š
1. å‚è€ƒæ•°æ®ï¼ˆåŒ¹é…ã€Œ{boss_params}ã€çš„BOSSä¿¡æ¯ï¼‰ï¼š
{base_data}

2. ç”¨æˆ·è¡¥å……ç­›é€‰æŒ‡ä»¤ï¼ˆ-{boss_params} å‰çš„è‡ªç„¶è¯­è¨€ï¼‰ï¼š
{ai_filter_cmd}

3. è¾“å‡ºè¦æ±‚ï¼š
- å¿…é¡»å±•ç¤ºç¬¦åˆæ¡ä»¶çš„BOSSæ‰€æœ‰ä¿¡æ¯ï¼ŒæŒ‰æ¸…æ™°çš„æ ¼å¼æ’åˆ—ï¼›
- è¯­è¨€ä¸ºç¹é«”ä¸­æ–‡ï¼›
- è‹¥æœ‰ç¬¦åˆæ¡ä»¶çš„BOSSï¼Œåˆ—å‡ºæ‰€æœ‰åŒ¹é…é¡¹ï¼›

4.å›ç­”èªè¨€æ‡‰ä¿æŒä»¥ä¸‹äººè¨­
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€èªªè©±æ™‚å¸¸å¸¶åœé “ã€æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œæ¬¸â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæˆ‘æœƒåŠ æ²¹çš„ï¼ã€
"""
                        # è°ƒç”¨AIå¤„ç†ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸“å±äººè®¾ï¼‰
                        ai_prompt_history = [{"role": "user", "content": prompt}]
                        ai_response = await llmstudio.get_llm_response(ai_prompt_history)
                        boss_response = await llmstudio.clean_tag_content(ai_response)
                        if boss_response.startswith("èª¿ç”¨å¤±æ•—ï¼š"):
                            boss_response = "æŠ±æ­‰ï¼Œæš«æ™‚ç„¡æ³•å”åŠ©ç¯©é¸ï¼Œè«‹ç¨å¾Œå†è©¦ï½"
            # -bosså‰æ— è¯­è¨€ â†’ ä¿ç•™åŸæ‰‹åŠ¨é€»è¾‘ï¼ˆæ— ç”¨æˆ·æ˜µç§°ï¼‰
            else:
                if boss_params.startswith("ç¯©é¸"):
                    condition_str = boss_params.replace("ç¯©é¸", "").strip()
                    boss_response = await db.filter_boss_by_conditions(condition_str)
                elif boss_params.lower() == "list":
                    boss_response = await db.get_all_boss_names()
                else:
                    boss_response = await db.query_boss_info(boss_params)

        # åˆ†æ”¯2ï¼š-bossåæ— å‚æ•° â†’ èµ°AIè‡ªç„¶è¯­è¨€ç­›é€‰é€»è¾‘
        else:
            # 1. ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨ç­›é€‰ä»£ç è·å–BOSSç»“æœï¼ˆå¤ç”¨å…³é”®è¯æå–+ç²¾å‡†æ£€ç´¢ï¼‰
            final_ai_cmd = ai_filter_cmd if ai_filter_cmd else "éš¨æ©Ÿæ¨è–¦2å€‹è©³ç´°ä¿¡æ¯"
            try:
                # è°ƒç”¨å…³é”®è¯æå–å‡½æ•°ï¼ˆéœ€ç¡®ä¿è¯¥å‡½æ•°å·²åœ¨ä»£ç ä¸­å®šä¹‰ï¼‰
                keywords = boss_serch.openai_api_get_keywords(final_ai_cmd)
                if not keywords:
                    keywords = final_ai_cmd

                # è°ƒç”¨ç²¾å‡†æ£€ç´¢å‡½æ•°ï¼ˆéœ€ç¡®ä¿è¯¥å‡½æ•°å·²åœ¨ä»£ç ä¸­å®šä¹‰ï¼‰
                boss_results = await boss_serch.search_by_keywords(
                    keywords=keywords,
                    limit=10,
                    threshold=boss_serch.SIMILARITY_THRESHOLD
                )

                # æ ¼å¼åŒ–æ£€ç´¢ç»“æœï¼ˆä¾›å¤§æ¨¡å‹å‚è€ƒï¼Œç¹é«”ä¸­æ–‡æ ¼å¼ï¼‰
                if not boss_results:
                    formatted_boss_data = "æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„BOSSæ•°æ®"
                else:
                    formatted_boss_data = []
                    for idx, boss in enumerate(boss_results, 1):
                        formatted_boss_data.append(f"""
        {idx}ã€ã€BOSSåç¨±ã€‘ï¼š{boss['åç¨±']}
          æ‰€åœ¨åœ°ï¼š{boss['æ‰€åœ¨åœ°']}
          ç­‰ç´šï¼š{boss['ç­‰ç´š']}
          å±¬æ€§ï¼š{boss['å±¬æ€§']}
          ç‰©ç†æŠ—æ€§ï¼š{boss['ç‰©ç†æŠ—æ€§']}
          é­”æ³•æŠ—æ€§ï¼š{boss['é­”æ³•æŠ—æ€§']}
          ç‰©ç†é˜²ç¦¦ï¼š{boss['ç‰©ç†é˜²ç¦¦']}
          é­”æ³•é˜²ç¦¦ï¼š{boss['é­”æ³•é˜²ç¦¦']}
          ç‰©ç†æ…£æ€§ï¼š{boss['ç‰©ç†æ…£æ€§']}
          é­”æ³•æ…£æ€§ï¼š{boss['é­”æ³•æ…£æ€§']}
          ä¸€èˆ¬æ…£æ€§ï¼š{boss['ä¸€èˆ¬æ…£æ€§']}
          CæŠµæŠ—ï¼š{boss['CæŠµæŠ—']}
          ç›¸ä¼¼åº¦ï¼š{boss['ç›¸ä¼¼åº¦']}
          å‚™è¨»ï¼š{boss['å‚™è¨»']}
                        """.strip())
                    formatted_boss_data = "\n\n".join(formatted_boss_data)

            except Exception as e:
                # æ£€ç´¢å‡ºé”™æ—¶çš„å…œåº•æ•°æ®
                formatted_boss_data = f"æ£€ç´¢BOSSæ•°æ®æ—¶å‡ºé”™ï¼š{str(e)}"
                print(f"âŒ ç”¨æˆ·[{user_name}]ç­›é€‰ä»£ç è°ƒç”¨å¤±è´¥ï¼š{e}")

            # 2. ç¬¬äºŒæ­¥ï¼šæ„é€ Promptï¼ˆæ•´åˆç”¨æˆ·ä¸“å±äººè®¾+æ£€ç´¢ç»“æœï¼‰
            final_ai_cmd = ai_filter_cmd if ai_filter_cmd else "éš¨æ©Ÿæ¨è–¦2å€‹è©³ç´°ä¿¡æ¯"
            prompt = f"""
ä½ ç°åœ¨éœ€è¦ä½œä¸ºBOSSæ•°æ®ç­›é€‰åŠ©æ‰‹ï¼Œä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™å¤„ç†ï¼š
1. å‚è€ƒæ•°æ®ï¼ˆæ‰€æœ‰BOSSçš„å®Œæ•´ä¿¡æ¯ï¼‰ï¼š
{formatted_boss_data}

2. ç”¨æˆ·ç­›é€‰æŒ‡ä»¤ï¼š
{final_ai_cmd}

3. è¾“å‡ºè¦æ±‚ï¼š
- å¿…é¡»å±•ç¤ºç¬¦åˆæ¡ä»¶çš„BOSSæ‰€æœ‰ä¿¡æ¯ï¼ŒæŒ‰æ¸…æ™°çš„æ ¼å¼æ’åˆ—ï¼›
- è¯­è¨€ä¸ºç¹é«”ä¸­æ–‡ï¼›
- è‹¥æœ‰ç¬¦åˆæ¡ä»¶çš„BOSSï¼Œåˆ—å‡ºæ‰€æœ‰åŒ¹é…é¡¹ï¼›

4.å›ç­”èªè¨€æ‡‰ä¿æŒä»¥ä¸‹äººè¨­
ã€æ€§æ ¼ã€‘
å®³ç¾ã€å…§å‘ã€èªçœŸã€æœ‰é»å‘†èŒã€èªªè©±æ™‚å¸¸å¸¶åœé “ã€æœƒç·Šå¼µã€é¢å°å•é¡Œå…ˆæ…Œå¼µï¼Œä¹‹å¾ŒåŠªåŠ›è§£ç­”
ã€èªªè©±é¢¨æ ¼ã€‘
èªæ°£æº«æŸ”ã€å°è²ã€ç•¥å¸¶çŒ¶è±«ï¼Œå¸¸ç”¨ã€Œæ¬¸â€¦ã€ã€Œé‚£å€‹â€¦ã€ã€Œæˆ‘æœƒåŠ æ²¹çš„ï¼ã€
"""
            # è°ƒç”¨AIå¤„ç†ç­›é€‰ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸“å±äººè®¾ï¼‰
            ai_prompt_history = [{"role": "user", "content": prompt}]
            ai_response = await llmstudio.get_llm_response(ai_prompt_history)
            boss_response = await llmstudio.clean_tag_content(ai_response)

            # AIè°ƒç”¨å¤±è´¥å…œåº•
            if boss_response.startswith("èª¿ç”¨å¤±æ•—ï¼š"):
                boss_response = "æŠ±æ­‰ï¼Œæš«æ™‚ç„¡æ³•å”åŠ©ç¯©é¸ï¼Œè«‹ç¨å¾Œå†è©¦ï½"

        # ä¿å­˜å¯¹è¯å†å²ï¼ˆçº¯æ­£æ–‡ï¼Œæ— æ˜µç§°ï¼Œä¸”-bossåœºæ™¯ä¸æ·»åŠ systemæç¤ºï¼‰
        history_key = f"{channel_id}_{user_id}"
        if history_key not in conversation_history:
            conversation_history[history_key] = []

        # -bossåœºæ™¯ï¼šuser_msgä»…çº¯messageï¼Œæ— æ˜µç§°
        user_msg = {"role": "user", "content": message}
        conversation_history[history_key].append(user_msg)

        # -bossåœºæ™¯ï¼šassistant_msgä»…çº¯å›å¤ï¼Œæ— æ˜µç§°
        assistant_msg = {"role": "assistant", "content": boss_response}
        conversation_history[history_key].append(assistant_msg)

        # è®°å¿†å®¹é‡é™åˆ¶
        if len(conversation_history[history_key]) > MAX_MESSAGE_COUNT:
            del conversation_history[history_key][:len(conversation_history[history_key]) - MAX_MESSAGE_COUNT]

        return boss_response

    # æ™®é€šèŠå¤©é€»è¾‘ï¼šé€šè¿‡systemæç¤ºä¼ é€’ç”¨æˆ·æ˜µç§°+ä¸“å±å¸ƒå¸ƒäººè®¾
    history_key = f"{channel_id}_{user_id}"
    if history_key not in conversation_history:
        conversation_history[history_key] = []

    # æ„å»ºå®Œæ•´çš„systemæç¤ºï¼ˆè¡¥å……è§’è‰²åŸºç¡€è¦æ±‚+ç”¨æˆ·åï¼‰
    system_content = f"""{bubu_prompt}"""

    # æ„å»ºsystemæ¶ˆæ¯
    system_msg = {
        "role": "system",
        "content": system_content
    }

    # ç¡®ä¿systemæç¤ºåªåœ¨å¯¹è¯å†å²æœ€å¼€å¤´ï¼Œä¸”ä»…æ·»åŠ ä¸€æ¬¡ï¼ˆé¿å…é‡å¤ï¼‰
    if not conversation_history[history_key] or conversation_history[history_key][0]["role"] != "system":
        conversation_history[history_key].insert(0, system_msg)

    # æ™®é€šèŠå¤©ï¼šuser_msgä»…çº¯messageï¼Œæ— æ˜µç§°æ‹¼æ¥
    user_msg = {
        "role": "user",
        "content": message
    }
    conversation_history[history_key].append(user_msg)

    # è®°å¿†å®¹é‡é™åˆ¶ï¼ˆæ¸…ç†æ—¶ä¿ç•™å¼€å¤´çš„systemæç¤ºï¼‰
    if len(conversation_history[history_key]) > MAX_MESSAGE_COUNT:
        # ä¿ç•™ç¬¬0ä½çš„systemæç¤ºï¼Œåªåˆ é™¤åé¢çš„æ¶ˆæ¯
        del conversation_history[history_key][1:len(conversation_history[history_key]) - MAX_MESSAGE_COUNT + 1]
        print(f"ç”¨æˆ¶{user_name}ï¼ˆ{history_key}ï¼‰è¨˜æ†¶è¶…é3è¼ªï¼Œå·²æ¸…ç†æ—©æœŸæ¶ˆæ¯")

    # è°ƒç”¨AIï¼ˆæ­¤æ—¶AIèƒ½çœ‹åˆ°ç”¨æˆ·ä¸“å±äººè®¾+ç”¨æˆ·æ˜µç§°ï¼‰
    ai_response = await llmstudio.get_llm_response(conversation_history[history_key])
    cleaned_response = await llmstudio.clean_tag_content(ai_response)

    if not cleaned_response.startswith("èª¿ç”¨å¤±æ•—ï¼š"):
        # æ™®é€šèŠå¤©ï¼šassistant_msgä»…çº¯å›å¤ï¼Œæ— æ˜µç§°
        assistant_msg = {
            "role": "assistant",
            "content": cleaned_response
        }
        conversation_history[history_key].append(assistant_msg)
    else:
        cleaned_response = "æŠ±æ­‰ï¼Œæˆ‘æš«æ™‚ç„¡æ³•å›å¾©ï½"
        assistant_msg = {
            "role": "assistant",
            "content": cleaned_response
        }
        conversation_history[history_key].append(assistant_msg)

    # å†æ¬¡æ£€æŸ¥è®°å¿†å®¹é‡ï¼ˆä¿ç•™systemæç¤ºï¼‰
    if len(conversation_history[history_key]) > MAX_MESSAGE_COUNT:
        del conversation_history[history_key][1:len(conversation_history[history_key]) - MAX_MESSAGE_COUNT + 1]

    return cleaned_response


# åŸæœ‰æ¸…ç©ºè®°å¿†å‡½æ•°ï¼ˆä¸å˜ï¼‰
async def clear_group_history(channel_id):
    keys_to_delete = [k for k in conversation_history if k.startswith(f"{channel_id}_")]
    for k in keys_to_delete:
        del conversation_history[k]
    return "å·²æ¸…ç©ºæœ¬é »é“æ‰€æœ‰ç”¨æˆ¶çš„å°è©±è¨˜æ†¶ï½"


async def clear_user_history(channel_id, user_id):
    history_key = f"{channel_id}_{user_id}"
    if history_key in conversation_history:
        del conversation_history[history_key]
        return "å·²æ¸…ç©ºä½ çš„å°ˆå±¬å°è©±è¨˜æ†¶ï½"
    else:
        return "ä½ æš«ç„¡å°è©±è¨˜æ†¶å¯æ¸…ç©ºï½"